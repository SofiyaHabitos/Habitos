<% id = session[:kitchen_user_id] %>
  

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment-with-locales.js"></script>  

    <link href="//cdn.rawgit.com/indrimuska/angular-moment-picker/master/dist/angular-moment-picker.min.css" rel="stylesheet">
    <script src="//cdn.rawgit.com/indrimuska/angular-moment-picker/master/dist/angular-moment-picker.min.js"></script>
   
</head>
<body>
<style>
  .modal-dialog {
    max-width: 999px;
  }

  div.panel-heading.test{
  color:red;
}
</style>



<section class="page-content">
<div class="container-fluid">
  <div class="row container_pad" ng-app="menu_cycle" ng-controller="MenuCycleCtrl" ng-init="onInit()">
    <div class="col-md-12 loading" ng-show="spinner">
      <img src="/assets/green_spinner.gif" height="70">
    </div>
    <div class="col-md-9 menu_body menuplanner_main_content">
      <div class="title_head">
        <h1 class="planner-title page_title">Menu Cycle Assign</h1>
      </div>
      <div class="row">
        <div class="col-md-3">
          <div class="control floating_label">
            <input type="text" class="input-text" name="plan-name" title="Plan Name" ng-model="planName" disabled="true">
          </div>
        </div>
        <div class="col-md-3">
          <div class="control floating_label" moment-picker="ctrl.datepicker" format="DD-MM-YYYY">
            <input type="text" name="date" class="input-text" placeholder="Date" value="{{date}}" disabled="true">
            <span class="input-icon">
              <i class="far fa-calendar-alt"></i>
            </span>
          </div>
        </div> 
        <div class="col-md-3 d-flex align-items-center">
          <label class="checkbox-label"><input type="checkbox" class="abc custom_checkbox" ng-model="qty" name="qty"> <span>Show Qty</span></label>
        </div>
      </div>
      <div id="menuplanner_accordion">
        <div class="card" ng-repeat="category in mealtime track by $index" ng-init="parentIndex = $index">
          <div class="card-header" id="headingOne"> <!-- ng-class="{'test':selected[$index]==getSelected(category.category_name, $index)}" -->
            <h5 class="mb-0">
              <button class="btn collapsed" data-toggle="collapse" data-target="#collapse{{$index}}" aria-expanded="false" aria-controls="collapse{{$index}}" ng-click="showClickIcon($index)" ng-cloak>
                {{category.category_name}}
              </button>
            </h5>
          </div>

          <div id="collapse{{$index}}" class="collapse" aria-labelledby="headingOne" data-parent="#menuplanner_accordion">
            <div class="card-body">
              <div class="table_overflow">
                <table class="table table-striped table-bordered table-hover display" cellspacing="0">
                  <thead>
                    <th style="background-color: #FFFFFF;width: 100px !important;" ng-repeat="dataa in additionRange track by $index" ng-init="headerDate= $index +1">
                     <label class="checkbox-label">
                        <span class="div-right">
                          <a href="#" editable-bsdate="dateEdit" e-is-open="opened.$data" e-ng-click="open($event,'$data')" e-ng-change="scopeFunction($data)" e-datepicker-popup="dd-MMMM-yyyy" onbeforesave="checkName($data,$index)">{{ (Range[$index] | date:"dd-MM-yyyy") }}<i class="fas fa-calendar-alt ml-1"></i></a>
                        </span>
                        <input type="checkbox" class="custom_checkbox"
                         ng-model="dateRange[parentIndex][category.category_name][0][dataa][0].CheckAll"
                         ng-change="toggleAll(parentIndex,category.category_name,dataa,dateRange[parentIndex][category.category_name][0][dataa][0].CheckAll)" ng-disabled="dateRange[parentIndex][category.category_name].length==0">
                        
                     </label>
                    </th>
                  </thead>
                  <tbody>
                    <tr ng-repeat="data1 in addRow[$index]" ng-init="dataindex = $index">
                      <td ng-repeat="date in dateRange[parentIndex][category.category_name][$index] track by $index" ng-init="data = $index +1" ng-if="dataLoaded==true">
                        <input class="custom_checkbox" type="checkbox" 
                        ng-model="date[0].rowSelect" 
                        ng-change="optionToggled(parentIndex,category.category_name,$index,date[0].rowSelect)">

                        <div name='country' id="category" custom-select="cate as cate.FoodCategory for cate in categories.RecepieCategoryWise | filter: $searchTerm" custom-select-options="level1Options" ng-model="category_type" required style="width:100%" ng-change="recipePush(category_type)" ng-init="category_type=dropDown1(date)"></div>

                        <div name='recipe_name' id="reciperecipe" custom-select="recipe as recipe.RecepieName for recipe in category_type.Foodrecipielist | filter: $searchTerm" ng-model="recipe" cs-depends-on="category_type" ng-change="recipePush(parentIndex,dataindex,$index,recipe,category.category_name,data)" ng-init="recipe=dropDown2(date,category_type.Foodrecipielist)" style="width:100%" required></div>

                        <span class="showrecipe" ng-show="category_type && qty">
                         Quantity :{{(dateRange[parentIndex][category.category_name][dataindex][additionRange[$parent.$index]][0].Portion_size * getquantity).toFixed(2)}}&nbsp;{{dateRange[parentIndex][category.category_name][dataindex][additionRange[$parent.$index]][0].UOM}}
                        </span>
                      </td>
                    </tr>
                  </tbody>                       
                </table>
              </div>
              <button class="btn addrow" ng-click="rowAdd($index,category.category_name)" ng-hide="!no_of_days">+ Add row</button> 
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 side_plan_item bgcolor menuplanner_sidebar">
      <div class="row planned_unplanned">
        <div class="col-md-6">
          <div class="card" data-toggle="modal" data-target="#myModal1">
              <div class="card-body">
                <h6>Planned</h6>
                <h2 ng-cloak>{{planned_count.count[0].planned}}</h2>
              </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card" data-toggle="modal" data-target="#myModal2">
              <div class="card-body">
                <h6>Un Planned</h6>
                <h2 ng-cloak>{{planned_count.count[0].Unplanned}}</h2>         
              </div>
          </div>
        </div>
      </div>

      <div class="meal_course" ng-init="assignedTenants()">
        <h6 class="title">Assigned Clients</h6>
        <div class="accordion" id="assigned_clients">
          <div class="card mb-2" ng-repeat="list in getTenants track by $index" ng-init="tourIndex = $index">
            <div class="card-header p-0" id="header_{{tourIndex}}">
              <h2 class="mb-0">
                <button class="btn collapsed" type="button" data-toggle="collapse" data-target="#client_{{tourIndex}}" aria-expanded="false" aria-controls="client_{{tourIndex}}" ng-cloak>
                  {{list.sub.sub_plan_name}}
                </button>
              </h2>
            </div>
            <div id="client_{{tourIndex}}" class="collapse" aria-labelledby="header_{{tourIndex}}" data-parent="#assigned_clients">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2" ng-repeat="tenant in list.tenant track by $index">
                  <label class="checkbox-label">
                   <input class="custom_checkbox " type="checkbox" ng-model="tenant.assign"  ng-checked="tenant.assign" name="check_tenant" ng-change="checkTenantUpdate(tenant.assign,$parent.$index,$index)" >
                    <span ng-click="InitialLoad(tenant)" ng-cloak>{{tenant.tenant_name}} - <span style="color:#ed5323;">{{tenant.meal_time}}</span></span>
                  </label>
                  <button type="button" class="btn btn-link"  ng-if="list.tenant.length==$index+1" ng-click="updateTenant(list.tenant,tourIndex)"> Update</button> 
                </div>
              </div>
            </div>
          </div>
        </div>
       <!--  <a href="/normalmenu_sites/menu_cycle" role="button" class="btn btn-primary proceed">Proceed to Menu</a> -->
        <div class="clearfix"></div>
      </div>

<!--       <div class="meal_course" ng-init="assignedTenants()">
        <label class="title">Assigned Clients</label><br><br>
        <div class="panel panel-default" ng-repeat="list in getTenants track by $index" ng-init="tourIndex = $index">
          <div class="panel-heading">
            <h4 class="panel-title">
              <i data-toggle="collapse" href="#123_{{tourIndex}}">
                {{list.sub.sub_plan_name}} 
              </i>
            </h4>
          </div>
          <div id="123_{{tourIndex}}" class="panel-collapse collapse">

            <div class="panel-body">
              <div ng-repeat="tenant in list.tenant track by $index">
                <input type="checkbox" ng-model="tenant.assign"  ng-checked="tenant.assign" name="check_tenant"><span ng-click="InitialLoad(tenant)">{{tenant.tenant_name}}</span>
                
                <button type="button" class="btn btn-primary"  ng-if="list.tenant.length==$index+1" style="float:right;margin-top: 10px;" ng-click="updateTenant(list.tenant,tourIndex)"> Update</button> 
              </div> 
            
            </div>
            
          </div>
        </div>
      </div> -->
      <div class="row">
        <div class="col-md-6">
          <div class="plancount">
              <label class="title">Client Type</label>
              <ul class="items">
                <li ng-repeat="client in clientList">
                  <label class="radio-label">
                    <input class="custom_radio" type="radio" ng-model="$parent.clientType" name="clienttype" value="{{client.name}}" ng-click="ClientType(client,'test')" disabled="true"> 
                    <span ng-cloak>{{client.name}}</span>
                  </label>
                </li>
              </ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="plancount">
              <label class="title">Client Category</label> <!-- ng-if="studenType != null" -->
              <ul class="items">
                <li ng-repeat="student in student_type">
                  <label class="radio-label">
                    <input class="custom_radio" type="radio" ng-model="$parent.studenType" name="studentype" value="{{student.name}}" ng-click="stud_type('Default')" disabled="true">
                    <span ng-cloak>{{student.name}}</span>
                  </label>
                </li>
              </ul>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="plancount">
            <label class="title">Spread Type</label>
            <ul class="items">
              <li ng-repeat="spread in SpreadName">
                <label class="radio-label">
                  <input class="custom_radio" type="radio" ng-model="$parent.spread_name" name="spread" value="{{spread.spreadtype}}" ng-click="stud_type('Default')" disabled="true">
                  <span ng-cloak>{{spread.spreadtype}}</span>
                </label>
              </li>
            </ul>
          </div>
        </div>
        <!-- <div class="col-md-6">
          <div class="plancount">
            <label class="title">Meal Type</label>
            <ul class="items">
              <li ng-repeat="meal in meal_type">
                <label class="radio-label">
                  <input class="custom_radio" type="radio" ng-model="$parent.mealname" name="meal_type" value="{{meal.name}}" ng-click="stud_type(meal)">
                  <span>{{meal.name}}</span>
                </label>
              </li>
            </ul>
          </div>
        </div> -->
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="plancount" ng-init="multidropdown()">
            <label class="title">Meal Course</label>
            <select  class="selectpicker" title="Choose Meal course" multiple ng-model="mealCourseName" required  style="width:100%" ng-change="stud_type('Default')" disabled="true"> 
              <option ng-repeat="course in mealtime">{{course.category_name}}</option>
            </select>
          </div>
        </div>
      </div>
      <div class="row mt-3 mb-3">
        <div class="col-md-12">
          <a href="/normalmenu_sites/menu_cycle" role="button" class="btn btn-primary proceed">Proceed </a>
          <a href="/menu_customers/cook_sheet_edit" role="button" class="btn btn-primary proceed">Cook Sheet</a>
        </div>
      </div>


<!--       <div class="row">
        <div class="col-md-12">
          <div class="plancount" ng-init="onInit()">
            <label class="title">Client Name</label>
            <ul class="items" ng-repeat="list in tenant_list">
              <li>
                <label class="checkbox-label">
                  <input class="custom_checkbox" type="checkbox" ng-model="list.checked"  ng-checked="list.checked" ng-change="check()" name="tenant_type" value="{{list.name}}">
                  <span>{{list.name}}</span>
                </label>
              </li>
            </ul>
          </div>
        </div>
      </div> -->
      <!-- <button class="btn btn-primary assign_btn" ng-click="menuAssign()" ng-disabled="!menu_plan_name || !ctrl.datepicker || !clientType || !mealCourseName  || !no_of_days || !studenType && clientType!='Corporate' || !spread_name || !mealname || !tenantCheckStatus">Assign</button>
      <a href="/normalmenu_sites/menu_cycle" role="button" class="btn btn-primary proceed">Proceed to Menu</a> -->
    </div>
    <div id="myModal1" class="modal fade" role="dialog">
      <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Planned Details</h4><span class="ti-close" data-dismiss="modal"></span>

            <!-- <button type="button" class="close" data-dismiss="modal">&times;</button> -->
          </div>
          <div class="modal-body modal-scroll">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Client Name</th>
                  <th>Meal Time</th>
                  <th>Clien Type Name</th>
                  <th>Client Category Name</th>
                  <th>Spread Name</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="plan in planned_count.planned_details">
                  <td>{{plan.tenant_name}}</td>
                  <td>{{plan.meal_time}}</td>
                  <td>{{plan.client_type}}</td>
                  <td>{{plan.stud_type}}</td>
                  <td>{{plan.spread_type}}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn_cancel" data-dismiss="modal">Close</button>
          </div>
        </div>

      </div>
    </div>
    <div id="myModal2" class="modal fade" role="dialog">
      <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
                  <h4 class="modal-title">Unplanned Details</h4><span class="ti-close" data-dismiss="modal"></span>

            <!-- <button type="button" class="close" data-dismiss="modal">&times;</button> -->
          </div>
          <div class="modal-body modal-scroll">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Client Name</th>
                  <th>Meal Time</th>
                  <th>Clien Type Name</th>
                  <th>Client Category Name</th>
                  <th>Spread Name</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="plan in planned_count.unplanned_details"> 
                  <td>{{plan.tenant_name}}</td>
                  <td>{{plan.meal_time}}</td>
                  <td>{{plan.client_type}}</td>
                  <td>{{plan.stud_type}}</td>
                  <td>{{plan.spread_type}}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn_cancel" data-dismiss="modal">Close</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
</section>

</body>
  <script type="text/javascript">
    $(document).ready(function() {
        /*$('#multi-select-demo').multiselect();*/
        $('.selectpicker').selectpicker();
    });

</script>

<script type="text/javascript">
var app = angular.module('menu_cycle', ["xeditable","ui.bootstrap",'AxelSoft']);
app.run(['editableOptions', function(editableOptions) {
  editableOptions.theme = 'bs3'; // bootstrap3 theme. Can be also 'bs2', 'default'
}]);
app.controller('MenuCycleCtrl', function($scope,$http,$rootScope,$window,$filter) {

//var plannerURL="http://api.idlidabba.com"
//var plannerURL="http://api.learnstein.com:81"
/*var plannerURL="http://192.168.1.73:3005";
var PimURL="http://192.168.0.48:8080";
*/

var plannerURL="<%= $api_service%>"
// var PimURL="http://182.72.104.66:8080"

var PimURL = '<%= $pim_core_service%>'  // "http://35.154.62.156"

$scope.planName="<%= params[:plan_name] %>";
$scope.dataLoaded=false;
$scope.spinner=true;
$scope.getquantity=1;
$scope.recipe="";
$scope.no_of_days="";
var count = $scope.no_of_days;

$scope.menu_assign_date="";
$scope.check;

$scope.selected=[];
$scope.getvalselected=[];
$scope.Range=[]
$scope.additionRange=[];
$scope.mealCourseName=[];
$scope.dataPortion=[];

/*$scope.student_type = [{
 "id":1,
 "type":'Primary' 
},{
 "id":2,
 "type":'Secondary',

},{
 "id":3,
 "type":'Corporate',
  
}];*/




  $scope.opened = {};

  $scope.open = function($event, elementOpened) {
   
    $event.preventDefault();
    $event.stopPropagation();

    $scope.opened[elementOpened] = !$scope.opened[elementOpened];
  };

$scope.showIcon=[];

$scope.dateRange=[];

$http.get(PimURL+"/pimcore/api/FoodRecepie/categorywiserecipie"
).then(function(response){
  $scope.spinner=false;
  $scope.categories = response.data;

})

$scope.multidropdown=function(){
   $scope.showIcon=[];
   
    $http.get(plannerURL+"/api/v1/categories")
        .then(function(response) {
            $scope.addRow=[];
            $scope.additionData=[];
            
            $scope.getAllCategories=[];
            //$scope.beforePush=[];

            $scope.mealtime = response.data;
            
  
            for(var i in $scope.mealtime){

              $scope.showIcon.push(false)
              var data=0;
              $scope.addRow.push([data]);
              //$scope.beforePush.push(i)
              $scope.getAllCategories.push($scope.mealtime[i].category_name)
              $scope.dateRange.push({[$scope.mealtime[i].category_name]:[]})
              $scope.additionData.push({[$scope.mealtime[i].category_name]:[]})
              
            }
            $scope.mealCourseName=[$scope.mealtime[0].category_name]
            setTimeout(() => {
              jQuery('.selectpicker').selectpicker('refresh');
            }, 500);
            
            localStorage.setItem("menuassign",JSON.stringify($scope.additionData))
           
           
    })
}

$scope.ClientType=function(client,test){
  
    /*$scope.stud_type('Default');*/
  //$scope.getquantity=1; 
  $http.get(plannerURL+'/api/v1/client_type_categories?client_type_id='+client.id).then(function(res){
    $scope.clientID=client.id;
    $scope.clientType=client.name;
    $scope.student_type = res.data["client_categories"];
    $scope.SpreadName = res.data["Spread"]
    if(test=="hello"){
      var spreadName=$scope.SpreadName.filter(function(res){ //spread_name
       return res.spreadid==$scope.spreadID;
      }).map(function(res){
       return res.spreadtype
      })
      //console.log(spreadName)
      $scope.spread_name=spreadName[0] || "";

    
      var studentName=$scope.student_type.filter(function(res){ //studenType
       return res.id==$scope.studentID;
      }).map(function(res){
       return res.name

      });
      // console.log(studentName)
      $scope.studenType=studentName[0] || "";
      $scope.stud_type($scope.meal_ID)
    }else{

      //console.log($scope.student_type)
      $scope.studenType=$scope.student_type[0].name;
      $scope.studentID=$scope.student_type[0].id;
      
      $scope.spread_name=$scope.SpreadName[0].spreadtype;
      $scope.spreadID=$scope.SpreadName[0].spreadid;
    }
    /* $scope.studenType=$scope.student_type[0];*/
    


   });
    
}

$scope.onInit=function(){
  $scope.tenantPlanDetails();
  $http.get(plannerURL+'/api/v1/site_categories').then(function(res){
      $scope.clientList=res.data["client_types"];
      $scope.student_type = res.data["client_categories"]
      //console.log($scope.student_type)
      $scope.clientType=$scope.clientList[0].name;
      $scope.clientID=$scope.clientList[0].id;
     
/*     $scope.studenType = 3;
*/     /*if($scope.clientType=='Corporate'){
       $scope.student_type=[];
       $scope.studenType=null;
     }else{
      $scope.student_type = [{
                             "id":1,
                             "type":'Primary' 
                            },{
                             "id":2,
                             "type":'Secondary',

                            },{
                             "id":3,
                             "type":'Corporate',
                              
                            }];
      
     }*/

     $http.get(plannerURL+"/api/v1/all_food_categories").then(function(response){
      
      $scope.meal_type = response.data
      $scope.mealname= $scope.meal_type[0].name;
      $scope.mealId=$scope.meal_type[0].id;      
       
      $scope.ClientType($scope.clientList[0],"test");
      
      $http.get(plannerURL+'/api/v1/client_type_categories?client_type_id='+$scope.clientID).then(function(res){
         $scope.student_type = res.data["client_categories"]
         //console.log($scope.student_type)
         $scope.studenType=$scope.student_type[0].name;
         $scope.studentID=$scope.student_type[0].id;
        $scope.SpreadName = res.data["Spread"]
        $scope.spread_name=$scope.SpreadName[0].spreadtype;
        $scope.spreadID=$scope.SpreadName[0].spreadid;
        $scope.stud_type($scope.meal_type[0]);
       }); 
      
     });
     
  });

  /*$http.get(PimURL+"/pimcore/api/FoodRecepie/SpreadName"
    ).then(function(response){
      $scope.SpreadName = response.data["Spread"]
    $scope.SpreadName=[];

    for(var i=0;i<response.data.SpreadNames.length;i++){
     $scope.SpreadName.push({"id":i+1,"spreadtype":response.data.SpreadNames[i].spreadtype});
    }

    
    $scope.spread_name=$scope.SpreadName[0].spreadtype;

    $scope.tenantPlanDetails();
*/
    
   /*
    });*/
/*})
*/
   
}

/*$scope.getSelected=function(val,i){
  $scope.getvalselected[i]=val;
  var getval = $scope.getvalselected;
  if($scope.mealCourseName.length!=0){
   //for(var j in $scope.mealtime){
      for(var i=0; i < $scope.mealCourseName.length; i++){
       if(val==$scope.mealCourseName[j]){
         $scope.selected[i]=val;
       }else{
         $scope.selected[i]=' ';
       }
      }
   //}      
  }
}*/


// $scope.getSelected=function(val){
//   var meals = $scope.mealCourseName;
//   var select = $scope.selected;
//   var mealtime = $scope.mealtime[0];
//   var getval = $scope.getSelected;
//   if($scope.mealCourseName.length!=0){
//    //for(var j in $scope.mealtime){
//       for(var i=0; i < $scope.mealCourseName.length; i++){
//        if(val==$scope.mealCourseName[j]){
//          $scope.selected[i]=val;
//        }else{
//          $scope.selected[i]=' ';
//        }
//       }
//    //}      
//   } 
// }

// $scope.getSelected=function(val){
//   if($scope.mealCourseName.length!=0){
//    for(var i in $scope.mealCourseName){
//       if(val==$scope.mealCourseName[i]){
         
//          $scope.selected[i]=true;
//       }else{
         
//          $scope.selected[i]=false;
//       } 
//    }
      
//   }
// }

$scope.Remove=function(index,details){
    for(var i in $scope.dateRange){        
      for(var j in $scope.dateRange[i]){         
          angular.forEach($scope.dateRange[i], function(value, key) {
              if(key ==details){
                $scope.dateRange[i][key].splice(index, 1);
              }
          });              
      }
    }
}

$scope.stud_type=function(test){
  console.log(test);
//$scope.getquantity=1;
 var spread_ID=$scope.SpreadName.filter(function(res){
  return res.spreadtype==$scope.spread_name;
 }).map(function(res){
  return res.spreadid
 });
 
 $scope.spreadID=spread_ID[0] || ""; 

 var student_ID=$scope.student_type.filter(function(res){
  return res.name==$scope.studenType;
 }).map(function(res){
  return res.id
 });
 
 $scope.studentID=student_ID[0] || "";

 $scope.getMealValues=[];
 if(test != "Default"){    
    $scope.mealId=test.id;
 }

 /*if($scope.clientType=='Corporate'){
       $scope.student_type=[];
       $scope.studenType=null;
  }else{
       $scope.student_type = [{
                             "id":1,
                             "type":'Primary' 
                            },{
                             "id":2,
                             "type":'Secondary',

                            },{
                             "id":3,
                             "type":'Corporate',  
       }];
       if($scope.studenType==null){
        $scope.studenType=$scope.student_type[0].type;
       }
  }
*/

 if($scope.mealCourseName==undefined || $scope.mealCourseName==null){
  $scope.getMealValues=[];
 }else if($scope.mealCourseName.length!=0  ){
   $scope.getMealValues=$scope.mealCourseName.map(function(res){
   return res;
  }) 
 }else{
  $scope.getMealValues=[];
 }
 /*console.log($scope.getMealValues)
 console.log($scope.clientID,$scope.spread_name,$scope.studenType,$scope.mealId)*/
 $http.get(plannerURL+'/api/v1/tenant_details/student_filter?site_category_id='+$scope.clientID+'&&spread_type='+$scope.spreadID+'&&stud_type='+$scope.studentID+'&&food_category_id='+$scope.mealId+'&&meal_time='+$scope.getMealValues).then(function(res){
   var data=res.data;
   $scope.tenant_list=[];
   if(data.length!=0){
   
     $scope.tenant_list=data.map(function(res){
       if($scope.tenantStatus==undefined){
        var data=-1
       }else{
        var data=$scope.tenantStatus.findIndex(m => m==res.tenant.id)
       }  
        if(data>-1){
          $scope.TenantState=true;
          $scope.tenantCheckStatus=true;
        }else{
          $scope.TenantState=false;
          $scope.tenantCheckStatus=false;
        }
       
       return {"id":res.tenant.id,"name":res.tenant.name,"checked":$scope.TenantState,"spread_type":res.spread_type,"stud_type":res.stud_type,"quantity":res.quantity}
       
     });

     //$scope.checkAssign();

   }else{
     $scope.tenant_list=[];
      $scope.tenantCheckStatus=false;
   }
  
   $scope.recipePush('test');
  });
}
  
$scope.InitialLoad=function(val){
   
 $scope.tenantStatus=[];
 $scope.addRow=[];
 $scope.Range=[];
 $scope.additionRange=[];
 
 $http.get(plannerURL+'/api/v1/menu_planners/assigned_tenant_details?sub_plan_id='+val.sub_plan_id+'&&tenant_detail_id='+val.tenantdetail_id)
 .then(function(res){
  
   $scope.getEditdata=res.data;
   $scope.tenant_quantity=$scope.getEditdata[0].tenant[0].quantity;
   $scope.date=res.data[0].tenant[0].date;
   $scope.studentID=res.data[0].tenant[0].stud_type; //studentID
   //console.log($scope.studentID)
   $scope.spreadID=res.data[0].tenant[0].spread_type; // spreadID
   //console.log($scope.spreadID)
  
   $scope.meal_ID={"id":res.data[0].tenant[0].food_category_id}
   $scope.mealId=res.data[0].tenant[0].food_category_id
   $scope.dateRangeDetails=res.data[0].meal_details;
   $scope.planName=res.data[0].tenant[0].plan_name;
   $scope.mealCourseName=(res.data[0].tenant[0].meal_time).split(",");
   
   setTimeout(() => {
     jQuery('.selectpicker').selectpicker('refresh');
   }, 500);
   
   $scope.clientID=res.data[0].tenant[0].site_category_id;
  // console.log($scope.clientID)
//console.log($scope.clientList)
   var clienTID=$scope.clientList.filter(function(res){
     return $scope.clientID==res.id;
   })
  // console.log(clienTID)
   $scope.clientType=clienTID[0].name;

   $scope.checkIndex=[];
   for(var i in $scope.dateRangeDetails){
    for(var j in $scope.dateRangeDetails[i]){
      $scope.checkIndex.push(j);
    }
   }
   var data=res.data[0].tenant[0].plan_for;
   $scope.no_of_days=res.data[0].tenant[0].plan_for;
   // for(var plan=1;plan<=data;plan++){
   //  $scope.Range.push('Day'+plan)
   // }
   for(var i in $scope.meal_type){
    if($scope.meal_type[i].id==$scope.meal_ID.id){
     
      $scope.mealname=$scope.meal_type[i].name
    }
   }
   for(var j in $scope.getEditdata){
    
    $scope.tenantStatus.push($scope.getEditdata[j]["tenant"][0].id);
   }


   
  
 
     

        $scope.addRow=[];
        $scope.getAllCategories=[];
        $scope.dateRange=[];
        
        
        for(var i in $scope.mealtime){
 
          $scope.showIcon.push(false)
          var data=0;
          $scope.addRow.push([data]);

          $scope.getAllCategories.push($scope.mealtime[i].category_name)

        }

        for(var cat in $scope.getAllCategories){
         
          var state=false;
          var checkdata=true;
          var state1=true;
          for(var date in $scope.dateRangeDetails){
            

            for(var date1 in $scope.dateRangeDetails[date]){

               
               var data=[]
               state1=$scope.getAllCategories[cat]==date1
               
               if($scope.getAllCategories[cat]==date1){
                state=true;

                 data=$scope.dateRangeDetails[date][date1];

                 $scope.dateRange.push({[$scope.getAllCategories[cat]]:data});
                 break;
               }else{                

                checkdata=$scope.checkIndex.indexOf($scope.getAllCategories[cat])>-1;
                if(checkdata==false && state1==false){
                  continue;
                }
                
               
               }
               
            }
            
            if(state==true){      
              break;
            }     
           
          }

          if(state==false && checkdata==false && state1==false){
              $scope.dateRange.push({[$scope.getAllCategories[cat]]:[]})
              
          }

           
        }
      $scope.tempArray=[];

     
      for(var i in $scope.dateRange){
        
        for(var j in $scope.dateRange[i]){
       
          for(var k in $scope.dateRange[i][j]){
            //var indexAt=0;
            for(var l in $scope.dateRange[i][j][k]){
              
              //indexAt+=1
              //console.log(indexAt)
              var data=$scope.Range.indexOf(l)==-1;
              if(data==true){
                $scope.Range.push(l.toString());
                $scope.additionRange.push(l.toString());
              }
              
               for(var m in $scope.dateRange[i][j][k][l]){
                
                   $scope.loopbreak=true;
                  
                   for(var n=0;n<$scope.categories.RecepieCategoryWise.length;n++){
                     
                    for(var y in $scope.categories.RecepieCategoryWise[n]){
                     
                      for(var o in $scope.categories.RecepieCategoryWise[n].Foodrecipielist){
                        
                       if($scope.categories.RecepieCategoryWise[n].Foodrecipielist[o].RecepieName==$scope.dateRange[i][j][k][l][m].name){
                         
                        // if(m!=0){
                          
                        //   if($scope.dateRange[i][j][k][l].length>1){
                         
                          
                          $scope.dateRange[i][j][k][l][m].dependant=$scope.categories.RecepieCategoryWise[n].FoodCategory;
                          
                          // if(m==$scope.dateRange[i][j].length){
                            
                           
                          //   var push={
                          //     [l] : [$scope.dateRange[i][j][k][l][m]]
                          //   };
                            
                          //   $scope.dateRange[i][j].push(push);
                            
                          //   $scope.dateRange[i][j][k][l].splice([m],1)
                            
                          //   $scope.loopbreak=false;
                            
                            
                            
                          // }else{
                          //   console.log(l)
                          //    $scope.getDataValue= $scope.dateRange[i][j][k][l][m]
                          //    console.log($scope.getDataValue)
                          //    console.log($scope.dateRange[i][j][0][l])
                          //    console.log($scope.dateRange[i][j][0][l][m])
                             //console.log($scope.dateRange[i][j][$scope.dateRange[i][j].length-1]["Day2"])
                      //        $scope.dateRange[i][j][$scope.dateRange[i][j].length-1][l]=[$scope.dateRange[i][j][k][l][m]];
                      //        console.log($scope.dateRange[i][j][$scope.dateRange[i][j].length-1][l])
                      //        //$scope.dateRange[i][j][$scope.dateRange[i][j].length-1][l].push($scope.getDataValue);
                              
                      //        $scope.dateRange[i][j][k][l].splice([m],1)
                           
                      //        $scope.loopbreak=false;
                             
                      //     }

                      //     }
                      // }else{
                       
                      //   $scope.dateRange[i][j][k][l][m].dependant=$scope.categories.RecepieCategoryWise[n].FoodCategory
                      //  }
                         
                       }
                        if($scope.loopbreak==false){
                          break;
                        }
                       
                      }
                      if($scope.loopbreak==false){
                          break;
                        }
                    }
                   if($scope.loopbreak==false){
                          break;
                        }
                   }
                 
                
               }

            }
          }
        }
      }

      for(var i=0;i<$scope.dateRange.length;i++){
        
          for(var j in $scope.dateRange[i]){
            
            for(k in $scope.dateRange[i][j]){
              
              if(k!=0){
                 $scope.addRow[i].push(Number(k));
              }
            }
            break;
          }
      }
      
      //$scope.stud_type($scope.meal_ID);
      $scope.ClientType(clienTID[0],"hello")
      $scope.dataLoaded=true;
           
     })
}

$scope.dropDown1=function(test){
  console.log(test)
  console.log($scope.dateRange)
 if($scope.categories==undefined){
   

    for(var i in $scope.categories.RecepieCategoryWise){
      if($scope.categories.RecepieCategoryWise[i].FoodCategory==test[0].dependant){
         $scope.categories.RecepieCategoryWise[i];
      }
    }
 }else{
  
    for(var i in $scope.categories.RecepieCategoryWise){
      if($scope.categories.RecepieCategoryWise[i].FoodCategory==test[0].dependant){
        return $scope.categories.RecepieCategoryWise[i];
      }
    }
   
 }
  
}



  $scope.checkName=function(data,index){
    
    if(data!=null && data!=undefined && data!=""){
      var compare_date=""
      var compare_date_state=0
      if(index!=0){
       compare_date = new Date($scope.Range[index-1].replace( /(\d{2})-(\d{2})-(\d{4})/, "$2/$1/$3"))
      }else{
       compare_date = new Date(data);
       compare_date.setDate(compare_date.getDate() - 1)
      }
     // console.log(compare_date)
      if(compare_date<data){
            $scope.addRange=[];
            var calc= new Date(data)
            var assign_previous="";
            for(var j=0;j<$scope.Range.length;j++){
              //console.log(j,index)
              if(j==index){
                calc= new Date(data)
               //console.log(calc)
              }else if(j<index){
                //console.log($scope.Range[j])
                //console.log(new Date($scope.Range[j]))
                /*var valid_date=""
                if($scope.Range[j].includes('Day')==true){
                  valid_date=$scope.Range[j];
                }else{
                  var date_field= $scope.Range[j].replace('-','/');
                  valid_date=date_field;
                }
               console.log(valid_date)*/
               //console.log(new Date($scope.Range[j].replace( /(\d{2})-(\d{2})-(\d{4})/, "$2/$1/$3"))=="Invalid Date") 
                if(new Date($scope.Range[j].replace( /(\d{2})-(\d{2})-(\d{4})/, "$2/$1/$3"))=="Invalid Date"){
                  calc= new Date(data)
                  calc.setDate(calc.getDate() +(parseInt(j)-parseInt(index)));
                //console.log(calc)
                  var previous=$filter('date')(calc, "dd-MM-yyyy");
                  assign_previous=previous;
                  //console.log(assign_previous)
                }else{
                  assign_previous=$scope.Range[j];
                  //console.log(assign_previous)
                }
              }else{
                calc.setDate(calc.getDate() + 1);
                //console.log(calc)
              }
              if(j<index){
                var assign_date=assign_previous;
                //console.log(assign_date)
              }else{
                var assign_date=$filter('date')(calc, "dd-MM-yyyy");
                //console.log(assign_date)  
              }
              
              $scope.addRange[j]=assign_date;
            } 
           
            $scope.Range=$scope.addRange;
      }else{
        alert("Selected date should be maximum than previous date")
      }
       
    }else{
      
      /*$scope.addRange=[];
      for(var i=0;i<=$scope.additionRange.length;i++){
        $scope.additionRange.push($scope.additionRange[i])
      }  
      $scope.Range=$scope.addRange;*/
    }
  }

$scope.dropDown2=function(test,test1){
  
   if($scope.categories==undefined){
     

      for(var i in test1){
        if(test1[i].RecepieName==test[0].name){
          // console.log(test1[i]);
          return test1[i];
        }
      }
   }else{
    
      for(var i in test1){
        if(test1[i].RecepieName==test[0].name){
          // console.log(test1[i]);
           return test1[i];
        }
      }
     
   }
  
}

  $scope.toggleAll = function(index,category,day,boolean) {
   console.log(index,category,day,boolean)
    for(var i in $scope.dateRange[index][category]){
    //  console.log(i)
      console.log($scope.dateRange[index][category][i][day])
      $scope.dateRange[index][category][i][day][0].rowSelect=boolean;
      $scope.dateRange[index][category][i][day][0].CheckAll=boolean;
    }
  }


  $scope.optionToggled = function(index,category,day,boolean){
   //console.log(index,category,day,boolean)
    var date=$scope.additionRange[day].toString();
    //console.log(date)
    for(var i in $scope.dateRange[index][category]){
      if(boolean==false){
       
        $scope.dateRange[index][category][i][date][0].CheckAll=boolean;
      //  console.log($scope.dateRange[index][category][i][date][0].CheckAll)
      }
    }
   // console.log($scope.dateRange[index]) 
    /*$scope.isAllSelected = $scope.options.every(function(itm){ return itm.selected; })*/
  }
 
  
  $scope.checkTenantUpdate=function(test,test1,index){
    console.log(test,test1,index)
    //console.log(test,test1)
   // console.log($scope.getTenants[test1]["tenant"])
    $scope.getquantity=0;
    for(var i = 0; i < $scope.getTenants[test1]["tenant"].length; i++){
       if($scope.getTenants[test1]["tenant"][i].assign==true){
         var product = $scope.getTenants[test1]["tenant"][i].quantity;
         $scope.getquantity += product;
      //   console.log($scope.getquantity)
       } 
        
    }
    if($scope.getquantity==0){
      $scope.getquantity=1;
    }

  }

   /*$scope.checkTenantUpdate=function(test,test1,index){
    //console.log(test,test1)
  //  console.log($scope.getTenants[test1]["tenant"])
    $scope.getquantity=0;
    for(var i = 0; i < $scope.getTenants[test1]["tenant"].length; i++){
       if($scope.getTenants[test1]["tenant"][i].assign==true){
         var product = $scope.getTenants[test1]["tenant"][i].quantity;
         $scope.getquantity += product;
      //   console.log($scope.getquantity)
       } 
        
    }
    if($scope.getquantity==0){
      $scope.getquantity=1;
    }

  }*/

  $scope.showClickIcon=function(index){

    /*for(var i=0;i<$scope.showIcon.length;i++){
      if(i==index){*/
       
         $scope.showIcon[index]==false? $scope.showIcon[index]=true:$scope.showIcon[index]=false;
        
  /*    }
    }*/
  }


  $scope.rowAdd=function(index,categoryName){

    
     for(var i=0;i<$scope.addRow.length;i++){ 
        if(i==index){
          
              if($scope.dateRange[index][categoryName].length>=1){
                $scope.addRow[i].push($scope.addRow[i].length)
              }
        
        }
     }
    
    for(var i in $scope.dateRange){
     
     for(var l in $scope.dateRange[i]){
         
        if(l==categoryName){
             var dayValue=[];
            if($scope.additionRange.length!=0){
               for(var j in $scope.additionRange){
                //var day = 'Day'+''+d.toString();
                var day=$scope.additionRange[j].toString();

                var boolean=false;
                if($scope.dateRange[i][l].length!=0){
                  if($scope.dateRange[i][l][0][day][0].CheckAll==true){
                    boolean=true
                  }else{
                    bolean=false;
                  }
                }else{
                  boolean=false;
                }

                var data={
                        [day] : [{"name":'',"qty":0,"dependant":'',"rowSelect":boolean,"CheckAll":boolean,"Portion_size":0,"UOM":""}]
                       };
               if(dayValue.length==0){ 
                dayValue=[data]
                }else{
                  dayValue[0][day]=[{"name":'',"qty":0,"dependant":'',"rowSelect":boolean,"CheckAll":boolean,"Portion_size":0,"UOM":""}]
                }
              }
              $scope.dateRange[i][l].push(dayValue[0]);
            }
             
        }else{

          var data=$scope.dateRange.findIndex((m,index) => m[categoryName])
          if(data==-1){
              var dayValue=[];
            if($scope.additionRange.length!=0){
              for(var j in $scope.additionRange){
                //var day = 'Day'+''+d.toString();
                var day=$scope.additionRange[j].toString();

                var boolean=false;
                if($scope.dateRange[i][l].length!=0){
                  if($scope.dateRange[i][l][0][day][0].CheckAll==true){
                    boolean=true
                  }else{
                    bolean=false;
                  }
                }else{
                  boolean=false;
                }

                var data={
                        [day] :  [{"name":'',"qty":0,"dependant":'',"rowSelect":boolean,"CheckAll":boolean,"Portion_size":0,"UOM":""}]
                       };
               if(dayValue.length==0){ 
                dayValue=[data]
                }else{
                  dayValue[0][day] = [{"name":'',"qty":0,"dependant":'',"rowSelect":boolean,"CheckAll":boolean,"Portion_size":0,"UOM":""}]
                }
              }
              
              $scope.dateRange.push({[categoryName]:dayValue}); 
            }  
          }
            
        }
     } 
       
    }
  }

  $scope.checkAssign=function(){
    $scope.tenant_list.some(checked);
    function checked(check){
      return check.checked==true
    }
    $scope.tenantCheckStatus=$scope.tenant_list.some(checked);
  }
 $scope.dataSplitPortion="";
 $scope.recipePush=function(parentIndex,parentindex,index,recipe,categoryName,date){
   console.log(parentIndex,parentindex,index,recipe,categoryName,date)
   var datefield=$scope.additionRange[date-1];
   //console.log(datefield)
  if(parentIndex!='test'){
    for(var i in $scope.dateRange){
      for(var j in $scope.dateRange[i]){
       
    
        if(j==categoryName){
         
            for(var a in $scope.categories.RecepieCategoryWise){
             for(var b in $scope.categories.RecepieCategoryWise[a]){
              for(var k in $scope.categories.RecepieCategoryWise[a][b]){
               //console.log($scope.categories.RecepieCategoryWise[a][b][k].RecepieName)
                 if(recipe==null || recipe==undefined || recipe==""){
                  var dayNum=datefield;

                  
                   $scope.dateRange[i][j][parentindex][dayNum][0].name="";
                   $scope.dateRange[i][j][parentindex][dayNum][0].qty=0;
                   $scope.dateRange[i][j][parentindex][dayNum][0].dependant="";
                   $scope.dateRange[i][j][parentindex][dayNum][0].Portion_size=0;
                   $scope.dateRange[i][j][parentindex][dayNum][0].UOM="";

                 }else{
                  var dayNum=datefield;
                  if($scope.categories.RecepieCategoryWise[a][b][k].RecepieName==recipe.RecepieName){
                  
                    $scope.dateRange[i][j][parentindex][dayNum][0].name=recipe.RecepieName;
                    $scope.dateRange[i][j][parentindex][dayNum][0].dependant=$scope.categories.RecepieCategoryWise[a].FoodCategory

                    for(var l in $scope.categories.RecepieCategoryWise[a][b][k].SpreadMaster){
                      
                      // for(var m in $scope.categories.RecepieCategoryWise[a][b][k][l]){
                          $scope.dataPortion=$scope.categories.RecepieCategoryWise[a][b][k].SpreadMaster[l].Portion_size.split(" ")
                          if($scope.categories.RecepieCategoryWise[a][b][k].SpreadMaster[l].clienttype==$scope.studenType && $scope.categories.RecepieCategoryWise[a][b][k].SpreadMaster[l].spreadtype==$scope.spread_name){
                            

                             // var quantity=0;
                             // if($scope.tenant_quantity!=null){
                             //   quantity =$scope.tenant_quantity
                             // }
                             
                             // console.log(quantity) 
                             //$scope.dataSplitPortion=$scope.categories.RecepieCategoryWise[a][b][k].SpreadMaster[l].Portion_size;
                             //$scope.dataPortion =$scope.dataSplitPortion.split(" ");
                             
                             $scope.dateRange[i][j][parentindex][dayNum][0].qty=$scope.categories.RecepieCategoryWise[a][b][k].SpreadMaster[l].Portion_size;

                            //$scope.dateRange[i][j][parentindex][dayNum][0].Portion_size=(dataPortion[0]*quantity).toFixed(2);
                            $scope.dateRange[i][j][parentindex][dayNum][0].Portion_size=$scope.dataPortion[0];
                            $scope.dateRange[i][j][parentindex][dayNum][0].UOM=$scope.dataPortion[1];

                          }else{
                            $scope.dateRange[i][j][parentindex][dayNum][0].qty=0;
                            $scope.dateRange[i][j][parentindex][dayNum][0].Portion_size=0;
                            $scope.dateRange[i][j][parentindex][dayNum][0].UOM="";
                          }

                      // }
                      
                    }
                    

                  }  
                 
                 } 
              } 
            }
           }
        }
      }
   
    }
$scope.stud_type('Default');

  }else{
 
  for(var i in $scope.dateRange){      
    
    for(var j in $scope.dateRange[i]){
      
      for(var k in $scope.dateRange[i][j]){
       
       for(var l in $scope.dateRange[i][j][k]){

        for(var m in $scope.dateRange[i][j][k][l]){
        
          if($scope.dateRange[i][j][k][l][m].name==""){
            
          }else{
          
            if($scope.dateRange[i][j][k][l][m].name!=""){
            
              for(var a in $scope.categories.RecepieCategoryWise){
               for(var b in $scope.categories.RecepieCategoryWise[a]){
                for(var c in $scope.categories.RecepieCategoryWise[a][b]){
                   
                  if($scope.categories.RecepieCategoryWise[a][b][c].RecepieName==$scope.dateRange[i][j][k][l][m].name){
                   
                    for(var d in $scope.categories.RecepieCategoryWise[a][b][c].SpreadMaster){
                      
                      //console.log($scope.categories.RecepieCategoryWise[a][b][c][d]);

                      if($scope.categories.RecepieCategoryWise[a][b][c].SpreadMaster[d].clienttype==$scope.studenType && $scope.categories.RecepieCategoryWise[a][b][c].SpreadMaster[d].spreadtype==$scope.spread_name){
                       
                         var quantity=0;
                         if($scope.tenant_quantity!=null){
                          quantity =$scope.tenant_quantity
                         }

                        
                       // $scope.dataSplitPortion=$scope.categories.RecepieCategoryWise[a][b][c].SpreadMaster[d].Portion_size;
                        $scope.dataPortion = $scope.categories.RecepieCategoryWise[a][b][c].SpreadMaster[d].Portion_size.split(" "); 
                        
                        $scope.dateRange[i][j][k][l][m].qty=$scope.categories.RecepieCategoryWise[a][b][c].SpreadMaster[d].Portion_size;

                        //$scope.dateRange[i][j][k][l][m].Portion_size=(dataPortion[0]*quantity).toFixed(2);
                        $scope.dateRange[i][j][k][l][m].Portion_size=$scope.dataPortion[0];
                        $scope.dateRange[i][j][k][l][m].UOM=$scope.dataPortion[1];
                       
                        break;
                      }else{
                       
                        $scope.dateRange[i][j][k][l][m].qty=0;
                        $scope.dateRange[i][j][k][l][m].Portion_size=0;
                        $scope.dateRange[i][j][k][l][m].UOM="";
                        
                      }
                    }
                  }
                }
               }
              }  
            }

          }
        }
       }
      }
    }
  } 
  }  
  //console.log($scope.dateRange)
}

 $scope.tenantPlanDetails=function(){
   $http.get(plannerURL+"/api/v1/menu_planners/menu_cycle_count_details").then(function(response){
     $scope.planned_count = response.data[0];

   });
 }


 $scope.assignedTenants=function(){
  $scope.getTenants=[];
  $http.get(plannerURL+"/api/v1/menu_planners/menuplanner_tenants?plan_name="+$scope.planName).then(function(res){
    var data=res.data;
    //$scope.getTenants=res.data;
    /*$scope.getTenants=data.map(function(res){
      return {"sub_plan_name":res.sub.sub_plan_name,"checked":false,"tenant":res.tenant}
    });*/
    for(var i=0;i<data.length;i++){
      for(var j=0;j<data[i].tenant.length;j++){
       
        data[i].tenant[j].assign=false;
      }
    }
    
    $scope.getTenants=data;
    
  })
 }




 //$scope.spinner=false;

 /*$scope.menuAssign=function(){
  if($scope.Range[0] == 'Day1'){
      alert("please select the date")
  }else{
    $scope.finall_dataRange="";
    $scope.getTenant=$scope.tenant_list.filter(function(res){
      return res.checked;
    }).map(function(res){
      return {"id":res.id,"stud_type":res.stud_type,"spread_type":res.spread_type,"plan_name":$scope.planName,"date":$scope.date, "food_category_id": $scope.mealId, "plan_for": $scope.no_of_days}
    });
    

       $scope.dateRange = JSON.stringify($scope.dateRange);
    for(var i=0;i<$scope.additionRange.length;i++){
      var str=$scope.additionRange[i];
      var regExp = new RegExp(str,'g');
      $scope.dateRange = $scope.dateRange.replace(regExp, $scope.Range[i]);
    }
    $scope.dateRange= JSON.parse($scope.dateRange);
    
    localStorage.setItem("dataRange",JSON.stringify($scope.dateRange));
    $scope.finall_dataRange=JSON.parse(localStorage.getItem("dataRange"))

    for(var h in $scope.Range){
      for(var j in $scope.finall_dataRange){
        for(var k in $scope.finall_dataRange[j]){
          for(var l in $scope.finall_dataRange[j][k]){
               if(l>0){   
               
                   $scope.finall_dataRange[j][k][0][$scope.Range[h]].push($scope.finall_dataRange[j][k][l][$scope.Range[h]][0]);
                   delete $scope.finall_dataRange[j][k][l][$scope.Range[h]];          
               }
          }
        }  
      }
    }


    // var allData=[];
    // for(var i in $scope.getAlldata){
    //   allData.push({[i]:$scope.getAlldata[i]})
    // }


    var data={"data":[{"tenant":$scope.getTenant},{"meal_details":$scope.finall_dataRange}]}

             console.log(data)

    $http.post(plannerURL+"/api/v1/menu_planners/create_menu_cycle",data).then(function(res){
      console.log(res.data);
      // $scope.menu_plan_name="";
      // $scope.menu_assign_date="";
      // $scope.no_of_days="";
      //location.href="/normalmenu_sites/menu_cycle";
    })
  }
}*/

$scope.updateTenant=function(list,index){
    $scope.spinner=true;
    var tenant_list=[];
  //  console.log($scope.studentID)
   // console.log($scope.spreadID)
    var mealCoursedata=$scope.mealCourseName.toString();
    tenant_list=list.filter(function(res){
      return res.assign
    }).map(function(res){
      return {"stud_type":$scope.studentID,"spread_type":$scope.spreadID,"plan_name":$scope.planName,"date":$scope.date, "food_category_id": $scope.mealId, "plan_for": $scope.no_of_days, "site_category_id": $scope.clientID,"meal_time": mealCoursedata,"sub_plan_id":res.sub_plan_id,"tenant_detail_id":res.tenantdetail_id}
    })
   
    if(tenant_list.length!=0){
        var data=[];
 
        $scope.dateRange = JSON.stringify($scope.dateRange);
       
        for(var i=0;i<$scope.additionRange.length;i++){
            var str=$scope.additionRange[i];
           
            if(str.includes('Day')==true && $scope.Range[i].includes('Day')==true){
              var regExp = new RegExp(str,'g');
              // console.log(regExp)
            
              $scope.dateRange = $scope.dateRange.replace(regExp, $scope.Range[i]);
            }else if(str.includes('Day')==true && $scope.Range[i].includes('Day')==false){
             
              var regExp = new RegExp(str,'g');
             
              var data=($scope.Range[i]+','+$scope.Range[i]).toString();
             
              $scope.dateRange = $scope.dateRange.replace(regExp, data);
            }else{
              

              var regExp = new RegExp(str,'g');
             
              var data=(str+','+$scope.Range[i]).toString();
             
              $scope.dateRange = $scope.dateRange.replace(regExp, data);
            }
            
          }
        $scope.dateRange= JSON.parse($scope.dateRange);
        //console.log($scope.dateRange)

        data=JSON.parse(localStorage.getItem("menuassign"))
       // console.log($scope.mealCourseName)
        for(var i in $scope.mealCourseName){
          for(var j in $scope.dateRange){

            for(var k in $scope.dateRange[j]){
              
              for(var l in $scope.dateRange[j][k]){
               for(var m in $scope.dateRange[j][k][l]){
                   
                   

                    if(k==$scope.mealCourseName[i]){
                      
                      if(data[j][k].length==0){
                       data[j][k]=[$scope.dateRange[j][k][0]]  
                      }else{
                       if(l!=0){
                         if($scope.dateRange[j][k].length!=data[j][k][0][m].length){
                           data[j][k][0][m].push($scope.dateRange[j][k][l][m][0]);  
                         }
                       } 
                      }
                      
                    }else{

                    } 
                  
               }
              }
              
              
            }
            
             
          }
         }
      
        
         setTimeout(function(){
         var assign={"data":[{"tenant":tenant_list},{"meal_details":data}]}

         $http.post(plannerURL+"/api/v1/menu_planners/create_menu_cycle",assign).then(function(res){
            // $scope.menu_plan_name="";
            // $scope.menu_assign_date="";
            // $scope.no_of_days="";
            //location.href="/normalmenu_sites/menu_cycle";
            if(res.data==true){
              $scope.spinner=false;
              alert('Your Menu has updated');
              $scope.dateRange=[];
              $scope.additionRange=[];
              $scope.Range=[];
              $scope.assignedTenants();
              $scope.tenantPlanDetails();
              $scope.onInit();
              $scope.multidropdown();
            }else{
              $scope.spinner=false;
              alert('Failed to update the Menu');
            }

          },function(error){
            $scope.spinner=false;
            alert('Failed to connect the server');
          })
     },1000)
   }else{
     $scope.spinner=false;
     alert("Please select client before update");
   }
 }
})



app.directive('draggable', function() {
  return function(scope, element, attrs) {
    var el = element[0];
    el.draggable = true; // Make dragable

    // Add event listeners
    el.addEventListener(
      'dragstart',
      function(e) {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('item_id', this.id);
        e.dataTransfer.setData('origin_id', el.parentElement.id);
        this.classList.add('dragging');
        return false;
      }, false
    );

    el.addEventListener(
      'dragend',
      function(e) {
        this.classList.remove('dragging');
        return false;
      },
      false
    );
  }
});

app.directive('droppable', function() {
  return function(scope, element, attrs) {
    // Get the native element
    var el = element[0];

    // Add event listeners
    el.addEventListener(
      'dragover',
      function(e) {
        e.preventDefault(); // Allow the drop

        // Set effects
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('dragover');
        return false;
      }, false
    );

    el.addEventListener(
      'dragenter',
      function(e) {
        this.classList.add('dragover');
        return false;
      }, false
    );

    el.addEventListener(
      'dragleave',
      function(e) {
        this.classList.remove('dragover');
        return false;
      }, false
    );

    el.addEventListener(
      'drop',
      function(e) {
        this.classList.remove('dragover');

        // Get the data
        var destination = this.id;
        var item_to_move = e.dataTransfer.getData('item_id');
        var origin = e.dataTransfer.getData('origin_id');

        // Call the scope move function
        scope.MoveItem(origin, destination, item_to_move);

        return false;
      }, false
    );
  }
});
app.directive('dateFormat', function() {
  return {
    require: 'ngModel',
    link: function(scope, element, attr, ngModelCtrl) {
      //Angular 1.3 insert a formater that force to set model to date object, otherwise throw exception.
      //Reset default angular formatters/parsers
      ngModelCtrl.$formatters.length = 0;
      ngModelCtrl.$parsers.length = 0;
    }
  };
});

</script>
<script type="text/javascript">
  $(document).ready(function () {
    $(".sidebar").toggleClass("hide-nav");
    $(".wrapper").toggleClass("active");

    $('.scroll').slimScroll({});

    $(".wrapper_rightbar").click(function(){
      $(this).toggleClass("rb_active");
            $("#rightbar").toggleClass("open_right");
            $(".right_sidebar_nav i.fa-chevron-left").toggleClass("fa-chevron-right");
    });
    $(".right_sidebar_nav").click(function(){
      $(".wrapper_rightbar").toggleClass("rb_active");
            $("#rightbar").toggleClass("open_right");
            $(".right_sidebar_nav i.fa-chevron-left").toggleClass("fa-chevron-right");
    });
    
    /*$(".dropdown").click(function(){
      $(this).toggleClass("open")
    });*/  

    $(".dd1").click(function(){
      $(this).toggleClass("open")
    });
        
    $(".dd2").click(function(){
     $(this).toggleClass("open")
    });

    $(".dd3").click(function(){
     $(this).toggleClass("open")
    });

    $(".dd4").click(function(){
      $(this).toggleClass("open")
    });
  

    $(".right_btn").click(function(){
      $(".wrapper_rightbar").toggleClass("rb_active");
            $("#rightbar").toggleClass("open_right");
            $(".right_sidebar_nav i.fa-chevron-left").toggleClass("fa-chevron-right");
    });

    $(".horizontal-tabs ul li a").click(function(){
            $(".horizontal-tabs ul li a").toggleClass("active");
    });    

   $("#tab_scrolls").horizontalTabs();

    

  });
</script>